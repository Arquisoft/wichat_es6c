ifndef::imagesdir[:imagesdir: ../images]

[[section-building-block-view]]

== Vista de bloques de construcci√≥n

=== Sistema general de caja blanca

image::05_whitebox.jpg["Diagram 5.1: Resumen del Sistema"]

Motivation::

El prop√≥sito principal del sistema es ejecutar un juego de preguntas con im√°genes o texto utilizando informaci√≥n obtenida din√°micamente de la Wikidata API y adem√°s teniendo la posibilidad de interactuar con un LLM para solicitar su ayuda o ayudarlo a encontrar la respuesta dependiendo del modo de juego. Esto permite a los usuarios interactuar con datos reales y actualizados, mejorando la experiencia de usuario y la utilidad de la aplicaci√≥n.

Bloques de construcci√≥n contenidos::

|===
|Building Blocks |Description

|WICHAT
|Parte principal de la aplicaci√≥n, que controla el flujo del juego, maneja la l√≥gica de negocio y coordina la interacci√≥n entre los servicios. Implementado en Node.js con un enfoque modular.

|BD
|Base de datos encargada de almacenar los datos relacionados con los usuarios y con las preguntas. Se utiliza MongoDB.

|Wikidata
|Fuente de datos a la que se conecta la aplicaci√≥n para obtener las im√°genes, las preguntas y la informaci√≥n para facilitar el trabajo de la aplicaci√≥n.

|LLM
|Modelo de lenguaje con el que el usuario puede interactuar para obtener pistas sobre las preguntas del juego.
|===

Interfaces importantes::

* Frontend ‚Üî API Gateway: Interfaz RESTful para la comunicaci√≥n entre el frontend y el backend.
* API Gateway ‚Üî Backend: Interfaz interna para enrutar solicitudes a los servicios.
* Backend ‚Üî Base de Datos: Interfaz para acceder y gestionar los datos almacenados.

=== Nivel 2 

image::05_2_whitebox2.png["Diagram 5.2: Desglose Wichat"]

Contained Building Blocks::

|===
|Building Blocks |Description

|API Gateway
|Punto de entrada unificado para todas las peticiones del frontend. Redirige solicitudes a los distintos servicios y expone m√©tricas y documentaci√≥n.

|Question Management
|Conjunto de servicios encargados de gestionar el ciclo de vida de las preguntas en la aplicaci√≥n. Incluye los siguientes componentes:

- **Question Generator Service**  
  Parte de la aplicaci√≥n encargada de conectarse a Wikidata y obtener im√°genes e informaci√≥n para las preguntas del juego.

- **Question Data Service**  
  Parte de la aplicaci√≥n encargada de tratar con la informaci√≥n de las preguntas conect√°ndose a la base de datos para almacenar esta informaci√≥n y eliminando las preguntas que ya han salido.

- **Question Service**  
  Parte de la aplicaci√≥n encargada de gestionar el ciclo de vida de las preguntas en la aplicaci√≥n. Orquesta dos componentes internos (`question-data-service` y `question-generator-service`). Es el encargado de relacionarse con el API Gateway y de recibir las peticiones de preguntas. Se encarga de la l√≥gica de negocio relacionada con las preguntas.
 

|User Management
|Conjunto de servicios encargados de gestionar la informaci√≥n del usuario. Incluye los siguientes componentes:

 - **User Service**  
  Parte encargada de tratar la informaci√≥n del usuario: puntuaci√≥n, historial, etc. Se conecta a la base de datos para almacenar esta informaci√≥n.  
 - **Authentication Service**  
  Parte encargada de administrar la autentificaci√≥n de usuarios. Se conecta a la base de datos para almacenar y comprobar los nombres y contrase√±as.
 - **History Service**  
  Parte encargada de el tratamiento de los datos de las partidas de todos los usuarios. Se conecta a la base de datos para almacenar esta informaci√≥n.

|LLM Service
|Parte encargada de la comunicaci√≥n con el modelo de lenguaje. Env√≠a la informaci√≥n necesaria para obtener las pistas del jugador y devolverlas.

|===

=== Nivel 3 
image::05_3_BlackBox_Question_Management.png["Diagram 5.3.1: Desglose de Question Management"]

|===
|Building Blocks |Description

|Question Generator Service
|Parte de la aplicaci√≥n encargada de conectarse a Wikidata y obtener im√°genes e informaci√≥n para las preguntas del juego.

|Question Data Service
|Parte de la aplicaci√≥n encargada de tratar con la informaci√≥n de las preguntas conect√°ndose a la base de datos para almacenar esta informaci√≥n y eliminando las preguntas que ya han salido.

|Question Service
|Parte de la aplicaci√≥n encargada de gestionar el ciclo de vida de las preguntas en la aplicaci√≥n. Orquesta dos componentes internos(question-data-service y question-generator-service). Es el encargado de relacionarse con gateway y de recibir las peticiones de preguntas. Se encarga de la l√≥gica de negocio relacionada con las preguntas.

|===

image::05_3_BlackBox_User_Management.png["Diagram 5.3.2: Desglose de User Management"]

|===
|Building Blocks |Description

|User Service
|Parte encargada de tratar la informaci√≥n del usuario: puntuaci√≥n, historial, etc. Se conecta a la base de datos para almacenar esta informaci√≥n.

|Authentication Service
|Parte encargada de administrar la autentificaci√≥n de usuarios. Se conecta a la base de datos para almacenar y comprobar los nombres y contrase√±as.

|History Service
|Parte encargada de el tratamiento de los datos de las partidas de todos los usuarios. Se conecta a la base de datos para almacenar esta informaci√≥n.

|===

==== Black Box: API Gateway

*Purpose/Responsibility*::

El API Gateway act√∫a como un √∫nico punto de entrada para todas las peticiones desde el frontend. Es responsable de:

- Redirigir solicitudes REST al servicio correspondiente (usuarios, autenticaci√≥n, historial, preguntas, modelo LLM).
- Unificar la interfaz de comunicaci√≥n entre cliente y microservicios.
- Agregar instrumentaci√≥n con Prometheus para monitoreo.
- Publicar documentaci√≥n del API utilizando Swagger (OpenAPI).
- Gestionar CORS y errores de red para los servicios backend.

*Interface(s)*::

- HTTP REST:
  - `/questions/:lang/:category` ‚Üí Question Generator Service.
  - `/createUserHistory`, `/getUserStats`, `/getLeaderboard` ‚Üí History Service.
  - `/user/profile/:username`, `/user/update/profile/:username` ‚Üí User Service.
  - `/login` ‚Üí Auth Service.
  - `/askllm` ‚Üí LLM Service.
  - `/api-doc` ‚Üí Exposici√≥n de documentaci√≥n Swagger.
  - `/health` ‚Üí Endpoint para chequeo de estado.

*Quality/Performance Characteristics*::

- Tolerancia a fallos b√°sica mediante manejo de errores HTTP con axios.
- Extensible: f√°cilmente ampliable a nuevos servicios.
- Observabilidad: expone m√©tricas para Prometheus.
- Documentado: incluye Swagger/OpenAPI.

*Directory/File Location*::

- Imagen Docker desplegada en Azure.

*Fulfilled Requirements*::

- Centraliza la entrada de peticiones HTTP.
- Permite escalabilidad y desacoplamiento entre frontend y servicios.
- Facilita pruebas y exploraci√≥n del sistema v√≠a documentaci√≥n autom√°tica.

*Open Issues/Problems/Risks*::

- Usa rutas fijas, sin descubrimiento din√°mico de servicios.

==== Black Box: Question Service

- **Responsabilidad**  
  Se encarga de gestionar el ciclo de vida de las preguntas en el juego. Orquesta dos componentes internos (`question-data-service` y `question-generate-service`) para:
  - Verificar si hay suficientes preguntas disponibles en la base de datos.
  - Generar nuevas preguntas si es necesario.
  - Devolver una pregunta aleatoria al usuario.
  - Eliminar la pregunta una vez ha sido servida.

- **Interfaces expuestas**
  - `GET /getQuestionsDb/:lang/:category`  
    Recibe solicitudes del API Gateway para obtener una pregunta aleatoria de una categor√≠a e idioma concretos. Se asegura de que haya suficientes preguntas generadas y disponibles.

- **Relaciones**
  - üîÅ **Internas:**
    - `question-data-service`: utilizado para obtener, contar, y eliminar preguntas desde la base de datos.
    - `question-generate-service`: encargado de generar nuevas preguntas usando informaci√≥n de Wikidata si no hay suficientes preguntas en la base de datos.
  - ‚ö° **Externas:**
    - Gateway Service (recibe la solicitud).

- **Datos**
  - Aunque no gestiona directamente almacenamiento, manipula datos almacenados en MongoDB a trav√©s de `question-data-service`.

- **Tecnolog√≠a**
  - Node.js
  - Express.js

- **Notas adicionales**
  - Incluye l√≥gica de espera y reintento si no hay suficientes preguntas disponibles en la base de datos.
  - No es un microservicio aut√≥nomo en t√©rminos de almacenamiento: depende de servicios internos para la persistencia y generaci√≥n.

==== Black Box: History Service

- **Responsabilidad**  
  Se encarga de gestionar y almacenar el historial de juegos de los usuarios, incluyendo su puntuaci√≥n, respuestas correctas/incorrectas, tiempo jugado y modo de juego. Tambi√©n proporciona estad√≠sticas detalladas y el ranking global de los jugadores.

- **Interfaces expuestas**
  - `POST /createUserHistory`  
    Recibe los datos del historial del juego de un usuario y lo almacena en la base de datos.
  - `GET /getUserHistory`  
    Devuelve el historial de juegos de un usuario espec√≠fico, identificado por su `username`.
  - `GET /getUserStats`  
    Obtiene estad√≠sticas agregadas sobre el rendimiento de un usuario, como el total de juegos jugados, respuestas correctas, incorrectas, tiempo total y puntuaci√≥n promedio.
  - `GET /getLeaderboard`  
    Devuelve el ranking global de los jugadores, ordenado por diferentes m√©tricas como la puntuaci√≥n total, precisi√≥n, tiempo promedio, etc.

- **Relaciones**
  - üîÅ **Internas:**
    - MongoDB: utilizado para almacenar y recuperar los datos de historial de usuario.
    - `UserHistory` (modelo de MongoDB): utilizado para definir y gestionar el esquema de los registros de historial de usuario.
  - ‚ö° **Externas:**
    - API Gateway (recibe las solicitudes del usuario y las redirige a este servicio).
    
- **Datos**
  - Almacena datos de historial de juego en una base de datos MongoDB, incluyendo:
    - `username`
    - `correctAnswers`
    - `wrongAnswers`
    - `time`
    - `score`
    - `gameMode`

- **Tecnolog√≠a**
  - Node.js
  - Express.js
  - MongoDB
  - Swagger para documentaci√≥n OpenAPI
  
- **Notas adicionales**
  - Utiliza **agregaci√≥n** en MongoDB para calcular estad√≠sticas y rankings globales.
  - El servicio soporta filtrado por diferentes criterios (e.g., por `username`, `sortBy`).
  - Implementa un sistema de rankings que tiene en cuenta varios criterios y asigna un **ranking global**.
  - Validaciones de entrada b√°sicas para asegurar que los datos sean consistentes antes de almacenarlos o procesarlos.

==== Black Box: Authentication Service

- **Responsabilidad**  
  Este servicio se encarga de gestionar la autenticaci√≥n de los usuarios. Proporciona funcionalidades como iniciar sesi√≥n, validando las credenciales del usuario y generando un **token JWT** para autenticar futuras solicitudes. Utiliza la base de datos para verificar las credenciales de usuario.

- **Interfaces expuestas**
  - `POST /login`  
    Recibe el `username` y la `password` de un usuario, verifica que sean correctos, y si lo son, genera un **token JWT** para la autenticaci√≥n del usuario.
    - **Entrada:** 
      - `username`: Nombre de usuario.
      - `password`: Contrase√±a del usuario.
    - **Salida:**
      - `token`: JWT que el cliente puede usar para autenticarse en futuras solicitudes.
      - `username`: El nombre de usuario.
      - `createdAt`: Fecha de creaci√≥n de la cuenta del usuario.

- **Relaciones**
  - üîÅ **Internas:**
    - MongoDB: utilizado para almacenar los datos de usuario.
    - `User` (modelo de MongoDB): modelo que define la estructura de los datos de usuario en la base de datos.
  - ‚ö° **Externas:**
    - API Gateway (gestiona las solicitudes que provienen del frontend y las dirige a este servicio).
    - **bcrypt**: para la encriptaci√≥n y comparaci√≥n de contrase√±as.
    - **jwt**: para la generaci√≥n y validaci√≥n de tokens de acceso.

- **Datos**
  - Almacena los datos del usuario en una base de datos MongoDB, incluyendo:
    - `username`: Nombre de usuario.
    - `password`: Contrase√±a encriptada del usuario.
    - `createdAt`: Fecha de creaci√≥n de la cuenta del usuario.

- **Tecnolog√≠a**
  - Node.js
  - Express.js
  - MongoDB
  - bcrypt (para encriptaci√≥n de contrase√±as)
  - jsonwebtoken (para la creaci√≥n de tokens JWT)
  - express-validator (para validaci√≥n de datos de entrada)

- **Notas adicionales**
  - La autenticaci√≥n se basa en la comparaci√≥n de contrase√±as encriptadas utilizando **bcrypt**.
  - El servicio genera un **token JWT** v√°lido por una hora, que debe ser incluido en las solicitudes subsecuentes para autenticar al usuario.
  - Se valida que los campos `username` y `password` sean proporcionados y cumplan con una longitud m√≠nima antes de procesar la solicitud.
  - El token JWT es enviado como respuesta en caso de que las credenciales sean correctas.
  - Si las credenciales son incorrectas, se devuelve un error de autenticaci√≥n (401).
